#!/usr/bin/env bash

set -euo pipefail

workdir=$(pwd)

# GPG stuff
if [ -z "${GPG_PRIVATE_KEY:-}" ]; then
  # Support reading the key from a file
  if [ -n "${GPG_PRIVATE_KEY_FILE:-}" ] && [ -e "${GPG_PRIVATE_KEY_FILE:-}" ]; then
    GPG_PRIVATE_KEY=$(cat "$GPG_PRIVATE_KEY_FILE")
    export GPG_PRIVATE_KEY
  fi
fi

if [ -z "${GPG_PASSPHRASE:-}" ] ; then
  # Support reading the passphrase from a file
  if [ -n "${GPG_PASSPHRASE_FILE:-}" ] && [ -e "${GPG_PASSPHRASE_FILE:-}" ] ; then
    GPG_PASSPHRASE=$(cat "$GPG_PASSPHRASE_FILE")
    export GPG_PASSPHRASE
  fi
fi

cd "$(dirname "$0")/.." && exec docker-compose run --rm -v "$workdir:$workdir" -w "$workdir" holocron "$@"
